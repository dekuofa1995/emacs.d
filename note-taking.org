#+title: Note-Taking

Configuration for writing with Emacs, specifically for Markdown and Org mode.

#+begin_src emacs-lisp
  ;;; -*- lexical-binding: t -*-
  (require 'init-const)
#+end_src

* Org
** Org Configurations
*** Load org by straight
#+begin_src emacs-lisp
  (use-package org
    ;; :pin org
    :defer t
    :custom
    (org-directory "~/Notes/org")
    (org-toggle-pretty-entities t)
    :bind
    (("C-c n c" . org-capture)
     :map org-mode-map
     ("C-c C-o" . org-open-at-point)
     ("M-<right>" . org-do-demote)
     ("M-<left>" . org-do-promote)
     ("M-S-<right>" . org-demote-subtree)
     ("M-S-<left>" . org-promote-subtree)
     ("M-<up>" . org-move-subtree-up)
     ("M-<down>" . org-move-subtree-down)
     ("C-c @" . org-mark-subtree)
     ;; refile: move content to better localtion/file
     ("C-c C-w" . org-refile)
     ("C-y" . org-yank)
     ("C-c *" . org-toggle-heading)
     ("C-c ^" . org-sort)
     ;; narrow and widen
     ("C-x n s" . org-narrow-to-subtree)
     ("C-x n b" . org-narrow-to-block)
     ("C-x n w" . widen)
     ("C-x C-v" . visible-mode) ;; toggle markup visibility
     )
    :config
    (define-key org-mode-map (kbd "C-'")  nil) ;; org-cycle-agenda-files use C-,
    )
#+end_src
*** Browser in Org

#+begin_src emacs-lisp
  (with-eval-after-load "org"
    (add-to-list 'browse-url-default-handlers
                 `("\\`eww:" . browse-url-firefox))
    (add-to-list 'browse-url-default-handlers
                 `("\\`w3m:" . browse-url-firefox))
    )
#+end_src

** COMMENT Using variable pitch font

Enable ~variable-pitch-mode~.

#+begin_src emacs-lisp

  ;; (use-package mixed-pitch
  ;;   :defer t
  ;;   :hook
  ;;   (org-mode . mixed-pitch-mode))

  (with-eval-after-load "org"
    ;; Use fixed pitch for table and code
    (custom-set-faces
     '(variable-pitch ((t :font-family "Sarasa Gothic CL")))
     '(org-table ((t :inherit 'fixed-pitch-serif)))
     '(org-code ((t :inherit 'fixed-pitch-serif)))
     '(org-block ((t :inherit 'fixed-pitch-serif)))
     '(org-checkbox ((t :inherit 'fixed-pitch :background nil :box nil)))
     '(org-latex-and-related ((t (:inherit 'fixed-pitch-serif))))))
#+end_src

** Enable org indent mode

#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'org-indent-mode)
#+end_src

** Ricing markups

#+begin_src emacs-lisp
  (defun meomacs--org-prettify-symbols ()
    (setq-local prettify-symbols-alist
                '(("#+begin_src" . "¬ª")
                  ("#+end_src" . "¬´")
                  ("#+begin_example" . "‚ùØ")
                  ("#+end_example" . "‚ùÆ")
                  ("#+begin_quote" . "‚Äü")
                  ("#+end_quote" . "‚Äü")
                  ("[X]" . "‚¶ø")
                  ("[ ]" . "üûÜ")
                  ("[-]" . "‚¶æ")))
    (prettify-symbols-mode 1))

  (add-hook 'org-mode-hook 'meomacs--org-prettify-symbols)

  (setq org-hide-emphasis-markers t)

  (with-eval-after-load "org"
    (add-to-list 'org-emphasis-alist '("=" (:box (:line-width -2 :color "gray50" :style released-button) :inherit org-verbatim))))
#+end_src

** Org Capture

#+begin_src emacs-lisp
  (setq org-capture-templates
        `(("i" "Inbox" entry (file "inbox.org")
           ,(concat "* TODO %?\n"
                    "/Entered on/ %U"))
          ("m" "Meeting" entry (file+headline "agenda.org" "Future")
           ,(concat "* %? :meeting:\n"
                    "<%<%Y-%m-%d %a %H:00>>"))
          ("n" "Note" entry (file "notes.org")
           ,(concat "* Note (%a)\n"
                    "/Entered on/ %U\n" "\n" "%?"))
          ))

  (defun org-capture-inbox ()
    (interactive)
    (call-interactively 'org-store-link)
    (org-capture nil "i"))

  (define-key global-map (kbd "C-c i") 'org-capture-inbox)
#+end_src


** Org Roam

#+begin_src emacs-lisp
  (use-package emacsql-sqlite-builtin :defer t)
  (use-package org-roam
    :defer t
    :custom
    (org-roam-directory (expand-file-name "~/Roam-Notes"))
    :init
    (setq org-roam-database-connector 'sqlite-builtin)
    :config
    (defvar org-roam-keymap
      (let ((keymap (make-keymap)))
        (define-key keymap "l" 'org-roam-buffer-toggle)
        (define-key keymap "f" 'org-roam-node-find)
        (define-key keymap "g" 'org-roam-graph)
        (define-key keymap "i" 'org-roam-node-insert)
        (define-key keymap "c" 'org-roam-capture)
        (define-key keymap "s" 'org-roam-db-sync)
        keymap))

    (defalias 'org-roam-keymap org-roam-keymap)
    (global-set-key (kbd "C-c r") 'org-roam-keymap)
    (with-eval-after-load "org-roam"
      (org-roam-setup)))
#+end_src

** COMMENT Good old template shortcut
#+begin_src emacs-lisp
    (with-eval-after-load "org"
        (require 'org-tempo))

#+end_src
** COMMENT Babel Languages
#+begin_src emacs-lisp
  (with-eval-after-load "org"
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((jupyter . nil)
       (julia . t)
       (emacs-lisp . t)
       (python .t )
       (C . t)
       )))
#+end_src

** Babel

#+begin_src emacs-lisp
  (defun meomacs-after-babel-execute ()
    (when org-inline-image-overlays
      (org-redisplay-inline-images)))

  (add-hook 'org-babel-after-execute-hook 'meomacs-after-babel-execute)
  ;; (use-package org-plus-contrib :defer t :after org)
#+end_src
*** C
#+begin_src emacs-lisp
  (use-package ob-C
    :ensure nil
    :load-path my/org-source-dir
    :commands (
               org-babel-execute:C
               org-babel-expand-body:C
               org-babel-execute:cpp
               org-babel-expand-body:cpp
               org-babel-execute:C++
               org-babel-expand-body:C++))
#+end_src
*** emacs-lisp
#+begin_src emacs-lisp
  (use-package ob-emacs-lisp
    :ensure nil
    :load-path my/org-source-dir
    :commands (org-babel-execute:emacs-lisp
               org-babel-expand-body:emacs-lisp))
#+end_src
*** jupyter
#+begin_src emacs-lisp
  (use-package ob-jupyter
    :ensure nil
    :load-path my/org-source-dir
    :commands (
               org-babel-execute:jupyter
               org-babel-expand-body:jupyter
               org-babel-expand-body:julia
               org-babel-execute:julia))
#+end_src

*** python
#+begin_src emacs-lisp
  (use-package ob-python
    :ensure nil
    :load-path my/org-source-dir
    :commands (org-babel-execute:python
               org-babel-expand-body:python))
#+end_src
*** ob-plantuml
#+begin_src emacs-lisp
  (use-package plantuml-mode
    :config
    (with-eval-after-load 'org
      (add-to-list 'org-src-lang-modes '("plantuml" . plantuml))))

  (use-package ob-plantuml
    :load-path my/org-source-dir
    :preface
    (with-eval-after-load 'exec-path-from-shell
      (let* ((brew_prefix (exec-path-from-shell-getenv "HOMEBREW_PREFIX"))
             (jar-name "plantuml.jar")
             (jar-path (format "%s/opt/plantuml/libexec/%s" brew_prefix jar-name)))
        (setq org-plantuml-jar-path jar-path)
        (unless (file-exists-p jar-path)
          (message "Load plantuml from BREW failed, Please check it in BREW"))))
    :commands (org-babel-execute:plantuml
               org-babel-expand-body:plantuml)
    )
#+end_src

** Latex
#+begin_src emacs-lisp
  (with-eval-after-load "org"
    (setq org-format-latex-options (plist-put org-format-latex-options :scale 4.0)))
#+end_src

** COMMENT Typst
+-------------+-------+
|compile      |C-c C-c|
+-------------+-------+
|preview      |C-c C-p|
+-------------+-------+
|toggle-watch |C-c C-w|
+-------------+-------+

#+begin_src emacs-lisp
  ;; dependence by typst-mode
  (use-package polymode)

  (use-package typst-mode
    :commands
    (typst-mode)
    :init
    (add-to-list 'auto-mode-alist '("\\.typ\\'" . typst-mode)))
#+end_src

* Markdown

#+begin_src emacs-lisp
  (use-package markdown-mode
    :defer t
    :bind
    (:map markdown-mode-map
          ("C-c v" . #'markdown-toggle-markup-hiding)))
#+end_src


* Denote

#+begin_src emacs-lisp
  (use-package denote
    :defer t
    :custom
    (denote-directory "~/Notes/Zk")
    (denote-dired-mode t)
    (denote-file-type ".org")
    (denote-templates
     `((review . "* Some heading\n\n* Another heading")
       (memo . ,(concat "* Some heading"
                        "\n\n"
                        "* Another heading"
                        "\n\n"))))
    :bind
    (
     ("C-c n n" . denote)
     ("C-c n N" . denote-type)
     ("C-c n d" . denote-date)
     ("C-c n z" . denote-signature)
     ("C-c n s" . denote-subdirectory)
     ("C-c n r" . denote-rename-file)
     ("C-c n i" . denote-link)
     ("C-c n I" . denote-link-add-links)
     ("C-c n b" . denote-link-backlinks)
     ("C-c n f f" . denote-link-find-file)
     ("C-c n f b" . denote-link-find-backlink)
     :map dired-mode-map
     ("C-c C-d C-i" . #'denote-link-dired-marked-notes)
     ("C-c C-d C-r" . #'denote-dired-rename-marked-files))
    )

#+end_src

** COMMENT Typst
#+begin_src emacs-lisp
  (with-eval-after-load 'denote

    (add-to-list 'denote-file-types
                 '(typst :extension ".typ"
                         :date-function denote-date-rfc3339
                         :front-matter denote-typst-front-matter
                         :title-key-regexp "^#let title\\s-*="
                         :title-value-function identity
                         :title-value-reverse-function denote-trim-whitespace-then-quotes
                         :keywords-key-regexp "#let tags\\s-*="
                         :keywords-value-function
                         denote-format-keywords-for-typst-front-matter
                         :keywords-value-reverse-function
                         denote-extract-typst-keywords-from-front-matter
                         :link denote-typst-link-format
                         :link-in-context-regexp denote-typst-link-in-context-regexp))
    (defun denote-format-keywords-for-typst-front-matter (keywords)
      (concat "("
              (mapconcat (lambda (k) (format "%S" k)) keywords ", ")
              ")"))

    (defun denote-extract-typst-keywords-from-front-matter (keywords-string)
      (if (string-blank-p keywords-string)
          ""
        (split-string keywords-string "," t "[][() \"']+")))

    (defvar denote-typst-link-format "#link(\"%2$s\")[denote:%1$s]"
      "The first is LINK and the second is DESC.")
    (defvar denote-typst-link-in-context-regexp
        (concat "#link\\(.*?\\)\\[denote:\\(?1:" denote-id-regexp "\\)]"))
    (defvar denote-typst-front-matter
          (concat
           "#let title		= \"%s\"\n"
           "#let date		= \"%s\"\n"
           "#let tags		= %s\n"
           "#let identifier	= \"%s\"\n"
           )))
#+end_src
** Integration with Org-Capture
#+begin_src emacs-lisp
  (with-eval-after-load 'org-capture
    (setq denote-org-capture-specifiers "%l\n%i\n%?")
    (add-to-list 'org-capture-templates
                 '("d" "New note (with denote)" plain
                   (file denote-last-path)
                   #'denote-org-capture
                   :no-save t
                   :immediate-finish nil
                   :kill-buffer t
                   :jump-to-captured t)))
#+end_src

* GTD

 Get Things Done.

** Org Agenda

#+begin_src emacs-lisp
  (setq org-agenda-files (list "inbox.org" "agenda.org" "projects.org"))
  (define-key global-map (kbd "C-c a") #'org-agenda)
  ;; remove the redundant tags
  (setq org-agenda-hide-tags-regexp ".")
  ;; include entries from Emacs diary into agenda
  ;; org-agenda-include-diary    t
  (setq org-agenda-prefix-format
        '((agenda . " %i %-12:c%?-12t% s")
          (todo   . " ")
          (tags   . " %i %-12:c")
          (search . " %i %-12:c")))
  ;; (define-key org-mode-map (kbd "C-'") nil) ;; orig. org-cycle-agenda-files
  ;; conflect with avy-goto-char-2
#+end_src

*** Refile
#+begin_src emacs-lisp
  (setq org-refile-targets
        '(("projects.org" :regexp . "\\(?:\\(?:Note\\|Task\\)s\\)")))

  (setq org-refile-use-outline-path 'file)
  (setq org-outline-path-complete-in-steps nil)
#+end_src

*** Task

**** Log time for task

#+begin_src emacs-lisp
  (defun log-todo-next-creation-date (&rest ignore)
    "Log NEXT creation time in the property drawer under the key 'ACTIVATED'"
    (when (and (string= (org-get-todo-state) "NEXT")
               (not (org-entry-get nil "ACTIVATED")))
      (org-entry-put nil "ACTIVATED" (format-time-string "[%Y-%m-%d]"))))

  (add-hook 'org-after-todo-state-change-hook #'log-todo-next-creation-date)
  (setq org-log-done 'time)
#+end_src

****  Keywords

#+begin_src emacs-lisp
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "FIXED(f)" "HOLD(h)" "HACK(H)" "|" "DONE(d)")))

#+end_src
